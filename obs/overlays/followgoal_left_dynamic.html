<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Followgoal Left - Dynamic Config</title>
    <style>
        @font-face {
            font-family: 'SEA';
            src: local('SEA'), url('SEA.ttf') format('truetype');
            font-display: swap;
        }
        
        :root {
            /* Variables CSS dynamiques (modifi√©es par le serveur JS) */
            --font-family: 'SEA';
            --font-size: 64px;
            --font-weight: normal;
            --text-color: white;
            --shadow-color: rgba(0,0,0,0.5);
            --stroke-color: black;
            --anim-duration: 1s;
            --anim-easing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --padding-left: 20px;
            --gap: 0;
        }
        
        body {
            background: transparent;
            margin: 0;
            font-family: var(--font-family), monospace;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            height: 100vh;
            color: var(--text-color);
            padding-left: var(--padding-left);
            padding-right: 0;
        }

        .counter {
            display: flex;
            font-size: var(--font-size);
            font-weight: var(--font-weight);
            gap: var(--gap);
            white-space: pre;
            text-shadow: 3px 3px 3px var(--shadow-color);
            -webkit-text-stroke: 1px var(--stroke-color);
        }

        .digit-container {
            position: relative;
            width: auto;
            min-width: 0.3em;
            height: 1.3em;
            overflow: hidden;
            display: inline-block;
        }

        .space-container {
            width: 0.25em;
            display: inline-block;
        }

        .digit {
            position: absolute;
            width: auto;
            white-space: nowrap;
            left: 0;
            text-align: left;
            transition: transform var(--anim-duration) var(--anim-easing);
        }

        .old {
            transform: translateY(0);
        }

        .new {
            transform: translateY(-100%);
        }

        .animate .old {
            animation: none;
        }

        .animate .new {
            animation: none;
        }

        @keyframes slideOut {
            0%   { transform: translateY(0); }
            100% { transform: translateY(100%); }
        }

        @keyframes slideIn {
            0%   { transform: translateY(-100%); }
            100% { transform: translateY(0); }
        }

        @keyframes slideOutUp {
            0%   { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }

        @keyframes slideInUp {
            0%   { transform: translateY(100%); }
            100% { transform: translateY(0); }
        }

        .animate-down .old {
            animation: slideOut 0.4s forwards ease-in-out;
        }

        .animate-down .new {
            animation: slideIn 0.4s forwards ease-in-out;
        }

        .animate-up .old {
            animation: slideOutUp 0.4s forwards ease-in-out;
        }

        .animate-up .new {
            animation: slideInUp 0.4s forwards ease-in-out;
        }
    </style>
</head>
<body>
    <div class="counter" id="counter"></div>

    <script>
        // ==================================================================
        // üé® CONNEXION WEBSOCKET POUR CONFIGURATION DYNAMIQUE
        // ==================================================================
        
        let configWs = null;
        
        function connectConfigWebSocket() {
            try {
                configWs = new WebSocket('ws://localhost:8084');
                
                configWs.onopen = () => {
                    console.log('‚úÖ Connect√© au WebSocket de configuration');
                };
                
                configWs.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'config_update' && data.config) {
                            console.log('üé® Nouvelle configuration re√ßue:', data.config);
                            applyConfig(data.config);
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur traitement message config:', error);
                    }
                };
                
                configWs.onerror = (error) => {
                    console.error('‚ùå Erreur WebSocket config:', error);
                };
                
                configWs.onclose = () => {
                    console.log('üîå WebSocket config d√©connect√©, reconnexion dans 3s...');
                    setTimeout(connectConfigWebSocket, 3000);
                };
                
            } catch (error) {
                console.error('‚ùå Erreur connexion WebSocket config:', error);
                setTimeout(connectConfigWebSocket, 3000);
            }
        }
        
        function applyConfig(config) {
            const root = document.documentElement;
            
            // Appliquer la police
            if (config.font) {
                if (config.font.family) root.style.setProperty('--font-family', config.font.family);
                if (config.font.size) root.style.setProperty('--font-size', config.font.size);
                if (config.font.weight) root.style.setProperty('--font-weight', config.font.weight);
            }
            
            // Appliquer les couleurs
            if (config.colors) {
                if (config.colors.text) root.style.setProperty('--text-color', config.colors.text);
                if (config.colors.shadow) root.style.setProperty('--shadow-color', config.colors.shadow);
                if (config.colors.stroke) root.style.setProperty('--stroke-color', config.colors.stroke);
            }
            
            // Appliquer l'animation
            if (config.animation) {
                if (config.animation.duration) root.style.setProperty('--anim-duration', config.animation.duration);
                if (config.animation.easing) root.style.setProperty('--anim-easing', config.animation.easing);
            }
            
            // Appliquer la mise en page
            if (config.layout) {
                if (config.layout.paddingLeft) root.style.setProperty('--padding-left', config.layout.paddingLeft);
                if (config.layout.gap) root.style.setProperty('--gap', config.layout.gap);
            }
            
            console.log('‚úÖ Configuration appliqu√©e');
        }
        
        // Charger la configuration initiale via HTTP
        async function loadInitialConfig() {
            try {
                const response = await fetch('http://localhost:3001/api/overlay-config');
                if (response.ok) {
                    const config = await response.json();
                    console.log('üìÑ Configuration initiale charg√©e:', config);
                    applyConfig(config);
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement config initiale:', error);
            }
        }
        
        // D√©marrer les connexions
        loadInitialConfig();
        connectConfigWebSocket();
        
        // ==================================================================
        // RESTE DU CODE ORIGINAL (WebSocket compteur, animations, etc.)
        // ==================================================================
        
        let ws;
        let currentGoal = 0;
        let currentCount = 0;
        let previousCount = 0;

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8083');

            ws.onopen = () => {
                console.log('‚úÖ Connect√© au WebSocket (compteur)');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'follow_update' && data.goal !== undefined) {
                        const goal = data.goal;
                        
                        // Formater le texte selon la structure de goal
                        let displayText;
                        if (goal.isMaxReached) {
                            displayText = goal.current.toString();
                        } else {
                            if (!goal.message || goal.message.trim() === '') {
                                displayText = `${goal.current}/${goal.target}`;
                            } else {
                                displayText = `${goal.current}/${goal.target} : ${goal.message}`;
                            }
                        }
                        
                        updateCounter(displayText);
                    }
                } catch (error) {
                    console.error('Erreur traitement message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('Erreur WebSocket (compteur):', error);
            };

            ws.onclose = () => {
                console.log('WebSocket compteur d√©connect√©, reconnexion dans 3s...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateCounter(newValue) {
            const counterElement = document.getElementById('counter');
            const oldValue = counterElement.textContent.trim();
            const newValueStr = String(newValue);

            if (oldValue === '' || oldValue === newValueStr) {
                counterElement.textContent = newValueStr;
                return;
            }

            const isIncreasing = newValue > parseInt(oldValue || '0');
            
            counterElement.innerHTML = '';
            
            for (let i = 0; i < newValueStr.length; i++) {
                const char = newValueStr[i];
                
                if (char === ' ') {
                    const spaceContainer = document.createElement('span');
                    spaceContainer.className = 'space-container';
                    counterElement.appendChild(spaceContainer);
                    continue;
                }

                const container = document.createElement('div');
                container.className = 'digit-container';
                
                if (i < oldValue.length && oldValue[i] !== char) {
                    container.classList.add('animate');
                    container.classList.add(isIncreasing ? 'animate-down' : 'animate-up');
                    
                    const oldDigit = document.createElement('div');
                    oldDigit.className = 'digit old';
                    oldDigit.textContent = oldValue[i];
                    container.appendChild(oldDigit);
                }

                const newDigit = document.createElement('div');
                newDigit.className = 'digit new';
                newDigit.textContent = char;
                container.appendChild(newDigit);

                counterElement.appendChild(container);
            }
        }

        connectWebSocket();
    </script>
</body>
</html>
